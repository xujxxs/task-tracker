# Profile Service

## Описание
**Profile Service** предоставляет функциональность для управления профилями пользователей, включая аватары, аутентификацию и авторизацию. Основные возможности:
- Управление профилями пользователей.
- Загрузка, получение и удаление аватаров.
- Регистрация, вход в систему и смена пароля.

Для хранения информации о пользователях используется **PostgreSQL**. В качестве кэширования данных используется **Redis**. Также для управления сессиями используется — **Spring Session**, который для хранения информации о сессиях использует — **MongoDB**. 

Сервис интегрируется с **RabbitMQ** для обмена сообщениями с **Task Service**. Сервис также использует **Amazon S3** для хранения и загрузки аватаров пользователей. В системе предусмотрены две роли:

- **User** — обычный пользователь, который может управлять только своим профилем.
- **Admin** — администратор, который может управлять профилями всех пользователей.


## API эндпоинты


### **Authentication Controller**

#### **Регистрация нового пользователя.**

**POST** `/api/auth/registration`

**Тело запроса:**
```json
{
    "username": "zxc",
    "password": "zxc",
    "user_details": {
        "email": "test3@example.com",
        "firstname": "Joseph",
        "lastname": "Filipov",
        "birth_date": "2000-01-12"
    }
}
```
**Ответ:**

HTTP статус: `200 OK`

Нет тела ответа

---

#### **Вход пользователя в систему.**

**POST** `/api/auth/login`

**Тело запроса:**
```json
{
    "username": "zxc",
    "password": "zxc"
}
```
**Ответ:**

HTTP статус: `200 OK`

Нет тела ответа

---

#### **Смена пароля текущего пользователя.**

**POST** `/api/auth/change/password`

**Тело запроса:**
```json
{
    "old_password": "qwe",
    "new_password": "qwee"
}
```
**Ответ:**

HTTP статус: `200 OK`

Нет тела ответа

---

#### **Выход из сессии.**

**POST** `/api/auth/logout`

**Тело запроса:**

Нет тела запроса.

**Ответ:**

HTTP статус: `200 OK`

Нет тела ответа

---

#### **Выход из всех сессий для текущего пользователя.**

**POST** `/api/auth/logout/all`

**Тело запроса:**

Нет тела запроса.

**Ответ:**

HTTP статус: `200 OK`

Нет тела ответа

---

### **Profile Controller**

#### **Получить текущий профиль пользователя.**

**GET** `/api/profile`

**Тело запроса:**

Нет тела запроса.

**Ответ:**

HTTP статус: `200 OK`

**Тело ответа:**
```json
{
    "id": 1,
    "username": "zxc",
    "email": "test3@example.com",
    "firstname": "Joseph",
    "lastname": "Filipov",
    "birthDate": "2000-01-12",
    "authorities": [
        {
            "authority": "USER"
        }
    ]
}
```

---

#### **Обновить профиль текущего пользователя.**

**PUT** `/api/profile`

**Тело запроса:**

```json
{
    "email": "test4@example.com",
    "firstname": "Josephich",
    "lastname": "Petrovich",
    "birth_date": "1990-01-01"
}
```

**Ответ:**

HTTP статус: `200 OK`

**Тело ответа:**
```json
{
    "id": 1,
    "username": "zxc",
    "email": "test4@example.com",
    "firstname": "Josephich",
    "lastname": "Petrovich",
    "birthDate": "1990-01-01",
    "authorities": [
        {
            "authority": "USER"
        }
    ]
}
```

---

#### **Удалить текущий профиль.**

**DELETE** `/api/profile`

**Тело запроса:**

Нет тела запроса.

**Ответ:**

HTTP статус: `204 NO CONTENT`

Нет тела ответа.

---

#### **Получить профиль пользователя по его ID**

**GET** `/api/profile/{id}`

Аналогично "**GET** `/api/profile`", но с указанием ID профиля. Ответ `200 OK` получат пользователь с таким ID или пользователи с ролью **ADMIN**.

---

#### **Обновить профиль пользователя по его ID**

**PUT** `/api/profile/{id}`

Аналогично "**PUT** `/api/profile`", но с указанием ID профиля. Ответ `200 OK` получат пользователь с таким ID или пользователи с ролью **ADMIN**.

---

#### **Удалить профиль пользователя по его ID**

**DELETE** `/api/profile/{id}`

Аналогично "**DELETE** `/api/profile`", но с указанием ID профиля. Ответ `204 NO CONTENT` получат пользователь с таким ID или пользователи с ролью **ADMIN**.

---

### **Avatar Controller**

#### **Получить аватар текущего пользователя.**

**GET** `/api/profile/avatar`

**Тело запроса:**

Нет тела запроса.

**Ответ:**

HTTP статус: `200 OK`

Изображение типа: `.jpeg`, `.jpg`.

---

#### **Загрузить аватар для текущего пользователя.**

**POST** `/api/profile/avatar`

**Тело запроса:**

Изображение типа: `.jpeg`, `.jpg`.

**Ответ:**

HTTP статус: `201 CREATED`

Нет тела ответа.

---

#### **Удалить аватар текущего пользователя.**

**DELETE** `/api/profile/avatar`

**Тело запроса:**

Нет тела запроса.

**Ответ:**

HTTP статус: `204 NO CONTENT`

Нет тела ответа.

---

#### **Получить аватар пользователя по его ID.**

**GET** `/api/profile/{id}/avatar`

Аналогично "**GET** `/api/profile/avatar`", но с указанием ID профиля. Ответ `200 OK` получат пользователь с таким ID или пользователи с ролью **ADMIN**.

---

#### **Загрузить аватар пользователя по его ID.**

**POST** `/api/profile/{id}/avatar`

Аналогично "**POST** `/api/profile/avatar`", но с указанием ID профиля. Ответ `200 OK` получат пользователь с таким ID или пользователи с ролью **ADMIN**.

---

#### **Удалить аватар пользователя по его ID.**

**DELETE** `/api/profile/{id}/avatar`

Аналогично "**DELETE** `/api/profile/avatar`", но с указанием ID профиля. Ответ `204 NO CONTENT` получат пользователь с таким ID или пользователи с ролью **ADMIN**.

## Исключения
Обрабатываемые исключения:
- **IOException** - Ошибка ввода-вывода (HTTP 400).
- **EmailUsedException** - Email уже используется (HTTP 403).
- **InvalidFileExtension** - Неверное расширение файла (HTTP 400).
- **InvalidFileName** - Неверное имя файла (HTTP 400).
- **InvalidPassword** - Неверный пароль (HTTP 401).
- **InvalidSignUpForm** - Неверная форма регистрации (HTTP 400).
- **NoAccessException** - Нет доступа (HTTP 403).
- **UsernameNotFoundException** - Имя пользователя не найдено (HTTP 404).
- **NotFoundException** - Ресурс не найден (HTTP 404).

## Зависимости
- **Spring Boot**: Основной фреймворк приложения.
- **Spring Security**: Аутентификация и авторизация.
- **PostgreSQL**: Хранилище данных пользователей.
- **MongoDB**: Хранилище сессий.
- **RabbitMQ**: Обмен сообщениями между сервисами.
- **AWS S3 (Backblaze B2)**: Хранилище для аватаров.

## Настройки

### Переменные окружения
**Настройки для PostgreSQL**:
- `DB_HOST`: Хост для подключения (по умолчанию `localhost`).
- `DB_PORT`: Порт для подключения (по умолчанию `5432`).
- `DB_NAME`: Имя базы данных (по умолчанию `profile`).
- `DB_USERNAME`: Логин для подключения (по умолчанию `profileapp`).
- `DB_PASSWORD`: Пароль для подключения (по умолчанию `profilepassword`).

**Настройки для MongoDB**:
- `SESSION_DB_HOST`: Хост для подключения (по умолчанию `localhost`).
- `SESSION_DB_PORT`: Порт для подключения (по умолчанию `27017`).
- `SESSION_DB_NAME`: Имя базы данных (по умолчанию `session`).`profilepassword`).

**Настройки для RabbitMQ**:
- `RABBITMQ_HOST`: Хост для подключения (по умолчанию `localhost`).
- `RABBITMQ_PORT`: Порт для подключения (по умолчанию `5672`).
- `RABBITMQ_USERNAME`: Логин для подключения (по умолчанию `profileapp`).
- `RABBITMQ_PASSWORD`: Пароль для подключения (по умолчанию `profilepassword`).

**Настройки для RabbitMQ**:
- `REDIS_HOST`: Хост для подключения (по умолчанию `localhost`).
- `REDIS_PORT`: Порт для подключения (по умолчанию `6379`).

**Настройки для S3 Cloud Storage**:
- `s3_endpoint`: Точка доступа для S3.
- `s3_region`: Регион S3.
- `s3_bucket_name`: Имя бакета для хранения файлов.
- `s3_access_key`: Ключ доступа для S3.
- `s3_secret_key`: Секретный ключ для доступа к S3.
